<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .image-and-content {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
    </style>
</head>
<body>
    <img src="/static/logo1.jpg" alt="TumorAI Logo" class="logo">
    <div class="container">
        <h2>Welcome, {{ fullname }}</h2> 
        <p> Previous session progress: {{ progress }} out of {{total}} questions</p>
        <button id="prevBtn" onclick="loadPrev()" class="styled-button">Load Previous Item</button>
        <button id="nextBtn" onclick="loadNext()" class="styled-button">Load Next Item</button>
        <div id="content" class="image-and-content">
            <img id="image" src="" alt="Press Load button and Images with questions will appear" width="800">
            <div>
                <p id="progress-display"></p>
                <div id="q1">
                	<p id="question1"></p>
                	<form id="options1"></form>
                </div>
                <div id="q2" style="margin-top: 16px;">
                	<p id="question2"></p>
                	<form id="options2"></form>
                </div>
                <button id="submitBtn" onclick="submitAnswer()" class="styled-button">Submit Answer</button>
                <button id="changeAnswerBtn" onclick="changeAnswer()" class="styled-button">Change Answer</button>
            </div>
        </div>
        <br>
        <a href="/logout">Logout</a>
    </div>

    <script>
        let currentProgress = {{ progress }};
        const totalQuestions = {{ total }};
        let currentImageName = "";
        let answeredQuestions = new Set();
        
        function loadAnsweredQuestions() {
            fetch("/api/get_answered_questions")
                .then(res => res.json())
                .then(data => {
                    answeredQuestions = new Set(data.answered);
                    loadQuestion(currentProgress);
                    updateNavigationButtonStates();
                });
        }
        
        function updateNavigationButtonStates() {
            document.getElementById("prevBtn").disabled = (currentProgress <= 0);
            document.getElementById("nextBtn").disabled = (currentProgress >= totalQuestions - 1);
        }

        function loadQuestion(progress) {
            if (progress >= totalQuestions) {
                document.getElementById("content").innerHTML = '<h2>Thank you! You have answered all questions!</h2>';
                return;
            }
            
            updateNavigationButtonStates();
            
            fetch(`/api/get_item/${progress}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("progress-display").innerText = `You are answering: ${data.progress + 1} out of ${totalQuestions}`;
                    document.getElementById("image").src = data.image;
                    document.getElementById("question1").innerText = data.q1.question || "";
                    document.getElementById("question2").innerText = data.q2.question || "";
                    currentImageName = data.image.split('/').pop();
                    
                    const optionsForm1 = document.getElementById("options1");
                    const optionsForm2 = document.getElementById("options2");
                    optionsForm1.innerHTML = '';
                    optionsForm2.innerHTML = '';
                    (data.q1.options || []).forEach(option => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="radio" name="answer1" value="${option}"> ${option}`;
                        optionsForm1.appendChild(label);
                    });
                    (data.q2.options || []).forEach(option => {
                        const label = document.createElement('label');
                        label.innerHTML = `<input type="radio" name="answer2" value="${option}"> ${option}`;
                        optionsForm2.appendChild(label);
                    });
                    
                    if (answeredQuestions.has(currentImageName)) {
                        fetch(`/api/get_user_answer/${currentImageName}`)
                            .then(res => res.json())
                            .then(answerData => {
                                if (answerData.answer1) {
                                    const r1 = document.querySelector(`input[name="answer1"][value="${answerData.answer1}"]`);
                                    if (r1) {
                                        r1.checked = true;
                                    }
                                }
                                if (answerData.answer2) {
                                    const r2 = document.querySelector(`input[name="answer2"][value="${answerData.answer2}"]`);
                                    if (r2) {
                                        r2.checked = true;
                                    }
                                }
                                
                                disableOptions(true);
                                document.getElementById("submitBtn").style.display = 'none';
                                document.getElementById("changeAnswerBtn").style.display = 'block';
                            });
                    } else {
                        disableOptions(false);
                        document.getElementById("submitBtn").style.display = 'block';
                        document.getElementById("changeAnswerBtn").style.display = 'none';
                        document.getElementById("submitBtn").disabled = false;
                    }
                });
        }
        
        function loadNext() {
             if (currentProgress < totalQuestions) {
                currentProgress++;
                loadQuestion(currentProgress);
            }
        }

        function loadPrev() {
            if (currentProgress > 0) {
                currentProgress--;
                loadQuestion(currentProgress);
            }
        }

        function submitAnswer() {
            const selected1 = document.querySelector('input[name="answer1"]:checked');
            const selected2 = document.querySelector('input[name="answer2"]:checked');
            if (!selected1 && !selected2) {
                alert('Please select at least one answer.');
                return;
            }

            const answer1 = selected1 ? selected1.value : null;
            const answer2 = selected2 ? selected2.value : null;

            fetch("/api/submit_answer", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    answer1: answer1,
                    answer2: answer2,
                    image_name: currentImageName
                })
            }).then(res => res.json())
              .then(data => {
                  if (data.status === "success") {
                      answeredQuestions.add(currentImageName);
                      loadNext();
                  } else {
                      alert("Error submitting answer.");
                  }
              });
        }

        function changeAnswer() {
            disableOptions(false);
            document.getElementById("changeAnswerBtn").style.display = 'none';
            document.getElementById("submitBtn").style.display = 'block';
            document.getElementById("submitBtn").innerText = "Update Answer";
            document.getElementById("submitBtn").onclick = updateAnswer;
        }

        function updateAnswer() {
            const selected1 = document.querySelector('input[name="answer1"]:checked');
            const selected2 = document.querySelector('input[name="answer2"]:checked');
            const newAnswer1 = selected1 ? selected1.value : null;
            const newAnswer2 = selected2 ? selected2.value : null;
            
            fetch("/api/change_answer", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    image_name: currentImageName,
                    new_answer1: newAnswer1,
                    new_answer2: newAnswer2
                })
            }).then(res => res.json())
              .then(data => {
                  if (data.status === "success") {
                      alert("Answer updated successfully!");
                      disableOptions(true);
                      document.getElementById("submitBtn").style.display = 'none';
                      document.getElementById("changeAnswerBtn").style.display = 'block';
                      document.getElementById("submitBtn").innerText = "Submit Answer";
                      document.getElementById("submitBtn").onclick = submitAnswer;
                  } else {
                      alert("Error updating answer.");
                  }
              });
        }

        function disableOptions(disabled) {
            document.querySelectorAll('#options1 input, #options2 input').forEach(el => {
                el.disabled = disabled;
            });
        }
        
        loadAnsweredQuestions();
    </script>
</body>
</html>